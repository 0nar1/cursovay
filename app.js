(function() {
	function pageHome() {
		return `
			<section class="hero">
				<div class="panel">
					<h1>–ê–∫–∞–¥–µ–º–∏—è ¬´TOP¬ª ‚Äî –æ–±—É—á–µ–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤—ã–º –Ω–∞–≤—ã–∫–∞–º</h1>
					<p>–ü—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –¥–µ—Ç–µ–π –∏ –≤–∑—Ä–æ—Å–ª—ã—Ö: –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–∏–∑–∞–π–Ω, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞. –£—á–∏—Ç–µ—Å—å –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –æ–±—É—á–µ–Ω–∏–µ–º –æ–Ω–ª–∞–π–Ω.</p>
					<div style="display:flex; gap:.5rem; margin-top:.75rem">
						<a class="btn" href="#/courses">–í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</a>
						<a class="btn ghost" href="#/schedule">–ë–ª–∏–∂–∞–π—à–∏–µ –∑–∞–Ω—è—Ç–∏—è</a>
					</div>
				</div>
				<div class="panel">
					<div class="grid cols-2">
						<div class="card service-card-1"><h3>–û–Ω–ª–∞–π–Ω‚Äë–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</h3><p class="muted">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∑–∞–¥–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã 24/7.</p></div>
						<div class="card service-card-2"><h3>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</h3><p class="muted">–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á.</p></div>
						<div class="card service-card-3"><h3>–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3><p class="muted">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏.</p></div>
						<div class="card service-card-4"><h3>–ö–∞—Ä—å–µ—Ä–Ω–æ–µ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3><p class="muted">–ü–æ–º–æ–≥–∞–µ–º —Å–æ —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞–º–∏ –∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏.</p></div>
					</div>
				</div>
			</section>

		<section class="section">
			<h2 class="section-title">–ü—Ä–æ–≥—Ä–∞–º–º—ã</h2>
			<div class="grid cols-4">
				<div class="card program-card-1"><h3>7‚Äì8 –ª–µ—Ç</h3><p class="muted">–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –ª–æ–≥–∏–∫–æ–π –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º.</p><a class="btn blue" href="#/courses">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>
				<div class="card program-card-2"><h3>9‚Äì12 –ª–µ—Ç</h3><p class="muted">Scratch, –æ—Å–Ω–æ–≤—ã Python –∏ –≤–µ–±‚Äë—Å—Ç—Ä–∞–Ω–∏—Ü.</p><a class="btn green" href="#/courses">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>
				<div class="card program-card-3"><h3>13‚Äì14 –ª–µ—Ç</h3><p class="muted">JavaScript, –∞–ª–≥–æ—Ä–∏—Ç–º—ã, –ø—Ä–æ–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞.</p><a class="btn orange" href="#/courses">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>
				<div class="card program-card-4"><h3>15‚Äì55 –ª–µ—Ç</h3><p class="muted">–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥, –∞–Ω–∞–ª–∏—Ç–∏–∫, QA, –¥–∏–∑–∞–π–Ω.</p><a class="btn purple" href="#/courses">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>
			</div>
		</section>

		<section class="section">
			<h2 class="section-title">–°–µ—Ä–≤–∏—Å—ã</h2>
			<div class="grid cols-2">
				<div class="card service-card-1"><h3>–°—Ç—É–¥–µ–Ω—Ç—É</h3><p class="muted">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç, –ø—Ä–æ–≥—Ä–µ—Å—Å, –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è.</p></div>
				<div class="card service-card-2"><h3>–ê–±–∏—Ç—É—Ä–∏–µ–Ω—Ç—É</h3><p class="muted">–ü–æ–¥–±–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.</p></div>
				<div class="card service-card-3"><h3>–ü–µ–¥–∞–≥–æ–≥—É</h3><p class="muted">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π.</p></div>
				<div class="card service-card-4"><h3>–û–Ω–ª–∞–π–Ω‚Äë–æ–ø–ª–∞—Ç–∞</h3><p class="muted">–£–¥–æ–±–Ω—ã–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã.</p></div>
			</div>
		</section>

		<section class="section">
			<h2 class="section-title">–ù–æ–≤–æ—Å—Ç–∏</h2>
			<div class="grid cols-2">
				<div class="card news-card"><h3>–°–∫–∏–¥–∫–∏ –∫–æ –¥–Ω—é —Ä–æ–∂–¥–µ–Ω–∏—è</h3><p class="muted">–ò–º–µ–Ω–∏–Ω–Ω–∏–∫–∞–º ‚Äî –º–∏–Ω—É—Å 15% –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ –≤ –º–µ—Å—è—Ü –ø—Ä–∞–∑–¥–Ω–∏–∫–∞.</p><a class="btn ghost" href="#/feedback">–£—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏</a></div>
				<div class="card news-card"><h3>–ê–∫—Ü–∏—è 1+1</h3><p class="muted">–ü—Ä–∏–≤–µ–¥–∏ –¥—Ä—É–≥–∞ –∏ –æ–±–∞ –ø–æ–ª—É—á–∏—Ç–µ –±–æ–Ω—É—Å—ã –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ.</p><a class="btn ghost" href="#/feedback">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</a></div>
			</div>
		</section>

		<section class="section">
			<h2 class="section-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
			<div class="card">
				<p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> +7 (495) 743‚Äë53‚Äë05</p>
				<p><strong>–ê–¥—Ä–µ—Å:</strong> –°–µ—Ä–≥–∏–µ–≤ –ü–æ—Å–∞–¥, –ø—Ä. –ö—Ä–∞—Å–Ω–æ–π –ê—Ä–º–∏–∏, 212–ê, –∫–æ—Ä–ø. 1, –æ—Ñ–∏—Å 12</p>
				<p class="muted">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É <a href="#/feedback">–æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</a> ‚Äî –æ—Ç–≤–µ—Ç–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
			</div>
		</section>
		`;
	}

	async function pageCourses() {
		const data = await DataStore.load();
		const list = data.courses || [];
		return `
			<section>
				<h2>–ö–∞—Ç–∞–ª–æ–≥ –∫—É—Ä—Å–æ–≤</h2>
				<div class="toolbar">
					<div class="filters">
						<input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/—Ç–µ–≥–∞–º" oninput="Pages.onCourseSearch(this.value)">
						<select id="level" onchange="Pages.onCourseFilterLevel(this.value)">
							<option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
							<option>–ù–∞—á–∏–Ω–∞—é—â–∏–π</option>
							<option>–°—Ä–µ–¥–Ω–∏–π</option>
							<option>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</option>
						</select>
					</div>
				</div>
				<div id="coursesList" class="grid cols-3">${list.map(UI.courseCard).join('')}</div>
			</section>
		`;
	}

	async function pageSchedule() {
		const data = await DataStore.load();
		const byId = Object.fromEntries((data.courses || []).map(c => [c.id, c]));
		const groupsById = Object.fromEntries((data.groups || []).map(g => [g.id, g]));
		const rows = (data.schedule || []).map(s => UI.scheduleRow(s, byId, groupsById)).join('');
		return `
			<section>
				<h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
				<div class="card">
					<div class="table-wrapper">
						<table class="table">
							<thead><tr><th>–î–µ–Ω—å</th><th>–í—Ä–µ–º—è</th><th>–ö—É—Ä—Å</th><th>–ì—Ä—É–ø–ø–∞</th><th>–ê—É–¥–∏—Ç–æ—Ä–∏—è</th></tr></thead>
							<tbody>${rows || `<tr><td colspan="5">${UI.emptyState('–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π')}</td></tr>`}</tbody>
						</table>
					</div>
				</div>
			</section>
		`;
	}

	function pageAccount() {
		const p = DataStore.getProfile();
		const user = DataStore.currentUser();
		const role = user?.role || p.role;
		return `
			<section>
				<h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
				<form class="card" onsubmit="Pages.onProfileSave(event)">
					<div class="row">
						<div>
							<label for="name">–ò–º—è</label>
							<input id="name" name="name" value="${escapeHtml(p.name)}" required>
						</div>
						<div>
							<label for="email">Email</label>
							<input id="email" name="email" type="email" value="${escapeHtml(p.email)}" required>
						</div>
					</div>
					<div>
						<label>–†–æ–ª—å</label>
						<div class="pill">${escapeHtml(role)}</div>
					</div>
					<div style="display:flex; gap:.5rem; margin-top:.75rem">
						<button class="btn" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
						<button class="btn ghost" type="button" onclick="Pages.onProfileReset()">–°–±—Ä–æ—Å–∏—Ç—å</button>
					</div>
				</form>
			</section>
		`;
	}

	function pageFeedback() {
		return `
			<section>
				<h2>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h2>
				<form class="card" onsubmit="Pages.onFeedbackSubmit(event)">
					<div class="row">
						<div>
							<label for="topic">–¢–µ–º–∞</label>
							<input id="topic" name="topic" placeholder="–í–æ–ø—Ä–æ—Å –ø–æ –∫—É—Ä—Å—É..." required>
						</div>
						<div>
							<label for="course">–ö—É—Ä—Å</label>
							<input id="course" name="course" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: JavaScript –ë–∞–∑–æ–≤—ã–π">
						</div>
					</div>
					<div>
						<label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
						<textarea id="message" name="message" rows="5" required></textarea>
					</div>
					<div style="display:flex; gap:.5rem; margin-top:.75rem">
						<button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
					</div>
				</form>
				<div id="feedbackToast" class="sr-only" aria-live="polite"></div>
			</section>
		`;
	}

	function pageLogin() {
		return `
			<section>
				<h2>–í—Ö–æ–¥</h2>
				<form class="card" onsubmit="Pages.onLogin(event)">
					<label for="loginEmail">Email</label>
					<input id="loginEmail" name="email" type="email" required>
					<label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
					<input id="loginPassword" name="password" type="password" required>
					<div style="display:flex; gap:.5rem; margin-top:.75rem">
						<button class="btn" type="submit">–í–æ–π—Ç–∏</button>
						<a class="btn ghost" href="#/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
					</div>
					<div class="login-demo">
						<p>–î–µ–º–æ-–¥–æ—Å—Ç—É–ø:</p>
						<ul>
							<li><strong>–ê–¥–º–∏–Ω:</strong> admin@top.local / admin</li>
							<li><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> teacher1@top.local / teacher1</li>
							<li><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> student1@top.local / student1</li>
						</ul>
					</div>
				</form>
			</section>
		`;
	}

	function pageRegister() {
		return `
			<section>
				<h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
				<form class="card" onsubmit="Pages.onRegister(event)">
					<div class="row">
						<div>
							<label for="regName">–ò–º—è</label>
							<input id="regName" name="name" required>
						</div>
						<div>
							<label for="regEmail">Email</label>
							<input id="regEmail" name="email" type="email" required>
						</div>
					</div>
					<label for="regPassword">–ü–∞—Ä–æ–ª—å</label>
					<input id="regPassword" name="password" type="password" minlength="6" required>
					<p class="input-hint">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤, —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –∑–Ω–∞–∫–∏.</p>
					<div style="display:flex; gap:.5rem; margin-top:.75rem">
						<button class="btn" type="submit">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
						<a class="btn ghost" href="#/login">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
					</div>
				</form>
			</section>
		`;
	}

	function pageStudentHomework() {
		const user = DataStore.currentUser();
		if (!user) return redirectLogin();
		
		const studentGroups = DataStore.getGroupsForStudent(user.id);
		const groups = DataStore.getGroups();
		const groupById = Object.fromEntries(groups.map(g => [g.id, g]));
		
		const allHomework = DataStore.listHomeworkForStudent(user.id);
		const list = allHomework.filter(h => studentGroups.includes(h.groupId));
		
		const db = (JSON.parse(localStorage.getItem('top-academy-db'))||{});
		const grades = (db.grades||[]).filter(g => g.studentId === user.id);
		const scheduleById = Object.fromEntries((db.schedule||[]).map(s => [s.id, s]));
		
		return `
			<section>
				<h2>–ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</h2>
				<div class="card">
					<h3>–ú–æ–∏ –≥—Ä—É–ø–ø—ã</h3>
					<div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
						${studentGroups.map(gId => {
							const group = groupById[gId];
							return group ? `<span class="pill blue">${group.name}</span>` : '';
						}).join('')}
					</div>
					<div class="table-wrapper">
						<table class="table">
							<thead><tr><th>–ö—É—Ä—Å</th><th>–ì—Ä—É–ø–ø–∞</th><th>–ó–∞–¥–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–û—Ü–µ–Ω–∫–∞</th></tr></thead>
							<tbody>
								${(list||[]).map(h => {
									const group = groupById[h.groupId];
									return `<tr>
										<td>${h.courseId}</td>
										<td>${group ? group.name : h.groupId}</td>
										<td>${h.title}</td>
										<td>${h.description||''}</td>
										<td>${h.grade??'-'}</td>
									</tr>`;
								}).join('') || `<tr><td colspan="5">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π</td></tr>`}
							</tbody>
						</table>
					</div>
				</div>
				<div class="card" style="margin-top:1rem">
					<h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏ –ø–æ –∑–∞–Ω—è—Ç–∏—è–º</h3>
					<div class="table-wrapper">
						<table class="table">
							<thead><tr><th>–î–∞—Ç–∞/–¥–µ–Ω—å</th><th>–í—Ä–µ–º—è</th><th>–ö—É—Ä—Å</th><th>–ì—Ä—É–ø–ø–∞</th><th>–û—Ü–µ–Ω–∫–∞</th></tr></thead>
							<tbody>
								${grades.map(g => { 
									const s = scheduleById[g.scheduleId]||{}; 
									const group = groupById[s.groupId];
									return `<tr>
										<td>${s.weekday||s.date||''}</td>
										<td>${s.time||''}</td>
										<td>${s.courseId||''}</td>
										<td>${group ? group.name : s.groupId}</td>
										<td>${g.grade}</td>
									</tr>`; 
								}).join('') || `<tr><td colspan="5">–û—Ü–µ–Ω–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>`}
							</tbody>
						</table>
					</div>
				</div>
			</section>
		`;
	}

function pageTeacherStudents() {
    const user = DataStore.currentUser();
    if (!user) return redirectLogin();
    if (user.role === '–°—Ç—É–¥–µ–Ω—Ç') return `<div class="card">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤</div>`;
    
    const teacherGroups = DataStore.getGroupsForTeacher(user.id);
    const groups = DataStore.getGroups();
    const groupById = Object.fromEntries(groups.map(g => [g.id, g]));
    
    const allUsers = DataStore.getUsers();
    const students = allUsers.filter(u => u.role === '–°—Ç—É–¥–µ–Ω—Ç' && 
        (u.groups || []).some(gId => teacherGroups.includes(gId)));
    
    const db = (JSON.parse(localStorage.getItem('top-academy-db'))||{});
    const schedule = (db.schedule || []).filter(s => teacherGroups.includes(s.groupId));
    const courses = db.courses || [];
    const courseById = Object.fromEntries(courses.map(c => [c.id, c]));
    
    return `
        <section>
            <h2>–ú–æ–∏ –≥—Ä—É–ø–ø—ã –∏ —Å—Ç—É–¥–µ–Ω—Ç—ã</h2>
            <div class="card">
                <h3>–ú–æ–∏ –≥—Ä—É–ø–ø—ã</h3>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    ${teacherGroups.map(gId => {
                        const group = groupById[gId];
                        return group ? `<span class="pill green">${group.name}</span>` : '';
                    }).join('')}
                </div>
                <p class="muted">–î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–Ω—è—Ç–∏–π: ${schedule.length}</p>
            </div>
            
            <div class="card">
                <h3>–°—Ç—É–¥–µ–Ω—Ç—ã –≤ –º–æ–∏—Ö –≥—Ä—É–ø–ø–∞—Ö</h3>
                <div class="table-wrapper">
                    <table class="table">
                        <thead><tr><th>–ò–º—è</th><th>Email</th><th>–ì—Ä—É–ø–ø—ã</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                        <tbody>
                            ${students.map(s => {
                                const studentGroups = s.groups || [];
                                const myGroups = studentGroups.filter(gId => teacherGroups.includes(gId));
                                return `<tr>
                                    <td>${s.name}</td>
                                    <td>${s.email}</td>
                                    <td>${myGroups.map(gId => {
                                        const group = groupById[gId];
                                        return group ? `<span class="pill blue">${group.name}</span>` : '';
                                    }).join(' ')}</td>
                                    <td>
                                        <button class="btn ghost" onclick="Pages.openAssignHw('${s.id}')">–ó–∞–¥–∞—Ç—å –î–ó</button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="hwModal" class="card" style="display:none; margin-top:1rem">
                <h3>–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
                <form class="form-stack" onsubmit="Pages.onAssignHw(event)">
                    <input type="hidden" name="studentId" id="hwStudentId">
                    <label>–ö—É—Ä—Å</label>
                    <select name="courseId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
                        ${courses.map(c => `<option value="${c.id}">${c.title}</option>`).join('')}
                    </select>
                    <label>–ì—Ä—É–ø–ø–∞</label>
                    <select name="groupId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                        ${teacherGroups.map(gId => {
                            const group = groupById[gId];
                            return group ? `<option value="${gId}">${group.name}</option>` : '';
                        }).join('')}
                    </select>
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input name="title" required>
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" rows="3"></textarea>
                    <div style="margin-top:.5rem">
                        <button class="btn" type="submit">–°–æ–∑–¥–∞—Ç—å</button>
                        <button class="btn ghost" type="button" onclick="Pages.closeAssignHw()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top:1rem">
                <h3>–û—Ü–µ–Ω–∫–∏ –ø–æ –∑–∞–Ω—è—Ç–∏—é</h3>
                <form class="form-stack" onsubmit="Pages.onSetGrades(event)">
                    <label>–ó–∞–Ω—è—Ç–∏–µ</label>
                    <select name="scheduleId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ</option>
                        ${schedule.map(s => {
                            const group = groupById[s.groupId];
                            const course = courseById[s.courseId];
                            return `<option value="${s.id}">${s.weekday||s.date||''} ${s.time||''} ‚Äî ${course ? course.title : s.courseId} (${group ? group.name : s.groupId})</option>`;
                        }).join('')}
                    </select>
                    <div class="grid cols-2" style="margin-top:.5rem">
                        ${students.map(s => `<div><label>${s.name}</label><input type=\"number\" min=\"1\" max=\"12\" step=\"1\" name=\"grade_${s.id}\" placeholder=\"–û—Ü–µ–Ω–∫–∞ 1-12\"></div>`).join('')}
                    </div>
                    <div style="margin-top:.5rem"><button class="btn" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button></div>
                </form>
            </div>

            <div class="card" style="margin-top:1rem">
                <h3>–î–ó –¥–ª—è –∑–∞–Ω—è—Ç–∏—è (–≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º –≥—Ä—É–ø–ø—ã)</h3>
                <form class="form-stack" onsubmit="Pages.onAssignHwForSession(event)">
                    <label>–ó–∞–Ω—è—Ç–∏–µ</label>
                    <select name="scheduleId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ</option>
                        ${schedule.map(s => {
                            const group = groupById[s.groupId];
                            const course = courseById[s.courseId];
                            return `<option value="${s.id}" data-course="${s.courseId}" data-group="${s.groupId}">${s.weekday||s.date||''} ${s.time||''} ‚Äî ${course ? course.title : s.courseId} (${group ? group.name : s.groupId})</option>`;
                        }).join('')}
                    </select>
                    <label>–¢–µ–º–∞</label>
                    <input name="title" required>
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" rows="3"></textarea>
                    <div style="margin-top:.5rem"><button class="btn" type="submit">–í—ã–¥–∞—Ç—å –î–ó</button></div>
                </form>
            </div>
        </section>
    `;
}

	function pageAdminManage() {
		const user = DataStore.currentUser();
		if (!user) return redirectLogin();
		if (user.role !== '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') return `<div class="card">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤</div>`;
		const users = DataStore.getUsers();
		const groups = DataStore.getGroups();
		const db = (JSON.parse(localStorage.getItem('top-academy-db'))||{});
		const schedule = db.schedule || [];
		const courses = db.courses || [];
		const predefinedLevels = ['–°—Ä–µ–¥–Ω–∏–π'];
		const extraLevels = Array.from(new Set(courses.map(c => c.level).filter(Boolean)))
			.filter(level => !predefinedLevels.includes(level));
		const groupById = Object.fromEntries(groups.map(g => [g.id, g]));
		const courseById = Object.fromEntries(courses.map(c => [c.id, c]));
		const userById = Object.fromEntries(users.map(u => [u.id, u]));
		
		return `
			<section>
				<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)</h2>
				<div class="admin-intro">
					<div class="card admin-auto-save">
						<h3>üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h3>
						<p>–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ localStorage –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –±–µ—Ä—É—Ç—Å—è –æ—Ç—Ç—É–¥–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
						<div class="auto-save-actions">
							<button class="btn green" type="button" onclick="Pages.forceReloadData()">–°–±—Ä–æ—Å–∏—Ç—å –∏–∑ BD.json</button>
							<button class="btn ghost" type="button" onclick="Pages.downloadBD()">–°–∫–∞—á–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</button>
						</div>
					</div>
					<div class="card admin-stats">
						<div class="stat-chip blue">
							<div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
							<div class="stat-value">${users.length}</div>
						</div>
						<div class="stat-chip green">
							<div class="stat-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</div>
							<div class="stat-value">${users.filter(u => u.role === '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å').length}</div>
						</div>
						<div class="stat-chip orange">
							<div class="stat-label">–°—Ç—É–¥–µ–Ω—Ç—ã</div>
							<div class="stat-value">${users.filter(u => u.role === '–°—Ç—É–¥–µ–Ω—Ç').length}</div>
						</div>
						<div class="stat-chip purple">
							<div class="stat-label">–ì—Ä—É–ø–ø—ã</div>
							<div class="stat-value">${groups.length}</div>
						</div>
						<div class="stat-chip">
							<div class="stat-label">–ó–∞–Ω—è—Ç–∏—è</div>
							<div class="stat-value">${schedule.length}</div>
						</div>
					</div>
				</div>
				<div class="admin-columns">
					<div class="admin-stack">
						<div class="card admin-section">
						<h3>–ì—Ä—É–ø–ø—ã</h3>
						<div class="table-wrapper">
							<table class="table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö—É—Ä—Å</th><th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th><th>–°—Ç—É–¥–µ–Ω—Ç—ã</th><th></th></tr></thead>
							<tbody>
								${groups.map(g => {
									const course = courseById[g.courseId] || {};
									const teacher = userById[g.teacherId] || {};
									const students = DataStore.getStudentsInGroup(g.id);
								return `<tr>
									<td>${g.name}</td>
									<td>${course.title || g.courseId}</td>
									<td>${teacher.name || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
									<td>${students.length}</td>
									<td><button class="btn danger btn-icon" type="button" aria-label="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É" title="–£–¥–∞–ª–∏—Ç—å" onclick="Pages.onRemoveGroup('${g.id}')">üóë</button></td>
								</tr>`;
								}).join('')}
							</tbody></table>
						</div>
						<form class="form-stack" onsubmit="Pages.onAddGroup(event)" style="margin-top:.5rem">
							<div class="row">
								<input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" required>
								<select name="courseId" required>
									<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
									${courses.map(c => `<option value="${c.id}">${c.title}</option>`).join('')}
								</select>
							</div>
							<div class="row">
								<select name="teacherId" required>
									<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
									${users.filter(u => u.role === '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å').map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
								</select>
							</div>
							<textarea name="description" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"></textarea>
							<div style="margin-top:.5rem"><button class="btn" type="submit">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button></div>
						</form>
					</div>
					<div class="card admin-section">
						<h3>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø—ã</h3>
						<div class="admin-filters">
							<input id="adminUsersSearch" class="admin-filter" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." oninput="Pages.onAdminFilterUsers()">
							<select id="adminUsersRole" class="admin-filter" onchange="Pages.onAdminFilterUsers()">
								<option value="">–í—Å–µ —Ä–æ–ª–∏</option>
								<option value="–°—Ç—É–¥–µ–Ω—Ç">–°—Ç—É–¥–µ–Ω—Ç—ã</option>
								<option value="–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</option>
								<option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
							</select>
						</div>
						<div class="table-wrapper">
							<table class="table" id="adminUsersTable"><thead><tr><th>–ò–º—è</th><th>–†–æ–ª—å</th><th>Email</th><th>–ì—Ä—É–ø–ø—ã</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
							<tbody>
								${users.map(u => {
									const studentGroups = (u.groups || []).map(gId => {
										const group = groupById[gId];
										return group ? `<span class="pill">${group.name}</span>` : '';
									}).join(' ');
									const availableGroups = groups.filter(g => !(u.groups || []).includes(g.id)).map(g => `<option value="${g.id}">${g.name}</option>`).join('');
									const actions = u.role === '–°—Ç—É–¥–µ–Ω—Ç'
										? `<select class="assign-select" onchange="Pages.onAssignStudentToGroup('${u.id}', this.value)">
											<option value="">–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</option>${availableGroups}</select>`
										: '';
									return `<tr data-role="${u.role}" data-name="${u.name.toLowerCase()}" data-email="${u.email.toLowerCase()}">
										<td>${u.name}</td>
										<td>${u.role}</td>
										<td>${u.email}</td>
										<td>${studentGroups}</td>
										<td>
											${actions}
											${u.role!=='–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'?`<button class="btn danger btn-icon" type="button" aria-label="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" title="–£–¥–∞–ª–∏—Ç—å" onclick="Pages.onRemoveUser('${u.id}')">üóë</button>`:''}
										</td>
									</tr>`;
								}).join('')}
							</tbody></table>
						</div>
						<div style="margin-top:.5rem"><a class="btn ghost" href="#/register">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a></div>
					</div>
					</div>
					<div class="admin-stack">
						<div class="card admin-section">
						<h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>
						<div class="admin-filters">
							<input id="adminScheduleSearch" class="admin-filter" type="search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–Ω—è—Ç–∏—è..." oninput="Pages.onAdminFilterSchedule()">
							<select id="adminScheduleCourse" class="admin-filter" onchange="Pages.onAdminFilterSchedule()">
								<option value="">–í—Å–µ –∫—É—Ä—Å—ã</option>
								${courses.map(c => `<option value="${c.id}">${c.title}</option>`).join('')}
							</select>
						</div>
						<div class="table-wrapper">
							<table class="table" id="adminScheduleTable"><thead><tr><th>–î–µ–Ω—å</th><th>–í—Ä–µ–º—è</th><th>–ö—É—Ä—Å</th><th>–ì—Ä—É–ø–ø–∞</th><th>–ê—É–¥.</th><th></th></tr></thead>
							<tbody>
								${schedule.map(s => {
									const group = groupById[s.groupId];
									return `<tr data-day="${(s.weekday||'').toLowerCase()}" data-time="${(s.time||'').toLowerCase()}" data-course="${(s.courseId||'').toLowerCase()}">
										<td>${s.weekday}</td>
										<td>${s.time}</td>
										<td>${s.courseId}</td>
										<td>${group ? group.name : s.groupId}</td>
										<td>${s.room}</td>
										<td><button class="btn danger btn-icon" type="button" aria-label="–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ" title="–£–¥–∞–ª–∏—Ç—å" onclick="Pages.onRemoveSchedule('${s.id}')">üóë</button></td>
									</tr>`;
								}).join('')}
							</tbody></table>
						</div>
						<form class="form-stack" onsubmit="Pages.onAddSchedule(event)" style="margin-top:.5rem">
							<div class="row">
								<input name="weekday" placeholder="–î–µ–Ω—å" required>
								<input name="time" placeholder="–í—Ä–µ–º—è" required>
							</div>
							<div class="row">
								<select name="courseId" required>
									<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
									${courses.map(c => `<option value="${c.id}">${c.title}</option>`).join('')}
								</select>
								<select name="groupId" required>
									<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
									${groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
								</select>
							</div>
							<input name="room" placeholder="–ê—É–¥–∏—Ç–æ—Ä–∏—è" required>
							<div style="margin-top:.5rem"><button class="btn" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button></div>
						</form>
					</div>
					<div class="card admin-section">
						<h3>–ö—É—Ä—Å—ã</h3>
						<div class="admin-filters">
							<input id="adminCoursesSearch" class="admin-filter" type="search" placeholder="–ü–æ–∏—Å–∫ –∫—É—Ä—Å–∞..." oninput="Pages.onAdminFilterCourses()">
							<select id="adminCoursesLevel" class="admin-filter" onchange="Pages.onAdminFilterCourses()">
								<option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
								<option value="–°—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</option>
								${extraLevels.map(level => `<option value="${level}">${level}</option>`).join('')}
							</select>
						</div>
						<div class="table-wrapper">
							<table class="table" id="adminCoursesTable"><thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–î–ª–∏—Ç.</th><th></th></tr></thead>
							<tbody>
								${courses.map(c => `<tr data-level="${(c.level||'').toLowerCase()}" data-title="${c.title.toLowerCase()}" data-tags="${(c.tags||[]).join(' ').toLowerCase()}">
									<td>${c.id}</td>
									<td>${c.title}</td>
									<td>${c.level||''}</td>
									<td>${c.duration||''}</td>
									<td><button class="btn danger btn-icon" type="button" aria-label="–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å" title="–£–¥–∞–ª–∏—Ç—å" onclick="Pages.onRemoveCourse('${c.id}')">üóë</button></td>
								</tr>`).join('')}
							</tbody></table>
						</div>
						<form class="form-stack" onsubmit="Pages.onAddCourse(event)">
							<div class="row">
								<input name="id" placeholder="id –∫—É—Ä—Å–∞ (–ª–∞—Ç–∏–Ω–∏—Ü–∞)" required>
								<input name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
							</div>
							<div class="row">
								<input name="level" placeholder="–£—Ä–æ–≤–µ–Ω—å (–ù–∞—á–∞–ª—å–Ω—ã–π/–°—Ä–µ–¥–Ω–∏–π/–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)">
								<input name="duration" placeholder="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–µ–¥–µ–ª–∏)">
							</div>
							<input name="tags" placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
							<textarea name="description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
							<div style="margin-top:.5rem"><button class="btn" type="submit">–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å</button></div>
						</form>
					</div>
					</div>
				</div>
			</section>
		`;
	}

	function redirectLogin() { location.hash = '#/login'; return ''; }

	function pageNotFound() {
		return `<div class="card"><h3>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h3><p class="muted">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π.</p></div>`;
	}

	function onCourseSearch(value) {
		const q = value.toLowerCase();
		DataStore.load().then(data => {
			const level = document.getElementById('level')?.value || '';
			const filtered = (data.courses||[]).filter(c =>
				(!level || (c.level||'').toLowerCase() === level.toLowerCase()) &&
				(!q || c.title.toLowerCase().includes(q) || (c.tags||[]).join(' ').toLowerCase().includes(q))
			);
			document.getElementById('coursesList').innerHTML = filtered.map(UI.courseCard).join('') || UI.emptyState('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
		});
	}
	function onCourseFilterLevel(value) { onCourseSearch(document.getElementById('q')?.value || ''); }

	function onProfileSave(e) {
		e.preventDefault();
		const form = e.target;
		const currentRole = DataStore.currentUser()?.role || DataStore.getProfile().role;
		const profile = { name: form.name.value.trim(), email: form.email.value.trim(), role: currentRole };
		DataStore.saveProfile(profile);
		alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
	}
	function onProfileReset() {
		DataStore.saveProfile({ role: '–°—Ç—É–¥–µ–Ω—Ç', name: '', email: '' });
		Router.render();
	}

	function onFeedbackSubmit(e) {
		e.preventDefault();
		const form = e.target;
		const entry = { topic: form.topic.value.trim(), course: form.course.value.trim(), message: form.message.value.trim() };
		if (!entry.topic || !entry.message) return;
		DataStore.upsertFeedback(entry);
		form.reset();
		const toast = document.getElementById('feedbackToast');
		toast.classList.remove('sr-only');
		toast.textContent = '–°–ø–∞—Å–∏–±–æ! –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.';
		setTimeout(() => { toast.classList.add('sr-only'); toast.textContent = ''; }, 2500);
	}

	async function onLogin(e) {
		e.preventDefault();
		const f = e.target; try {
			await DataStore.login(f.email.value.trim(), f.password.value.trim());
			Router.render();
			location.hash = '#/';
		} catch(err){ alert(err.message); }
	}
	async function onRegister(e) {
		e.preventDefault();
		const f = e.target;
		const password = f.password.value || '';
		if (password.length < 6) {
			alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.');
			return;
		}
		try {
			await DataStore.addUser({ name: f.name.value.trim(), email: f.email.value.trim(), password });
			alert('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –í–æ–π–¥–∏—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à email –∏ –ø–∞—Ä–æ–ª—å.');
			location.hash = '#/login';
		} catch(err){ alert(err.message); }
	}
	function onLogout() { DataStore.logout(); Router.render(); }

	function openAssignHw(studentId) {
		document.getElementById('hwStudentId').value = studentId;
		document.getElementById('hwModal').style.display = 'block';
	}
	function closeAssignHw() { document.getElementById('hwModal').style.display = 'none'; }
	async function onAssignHw(e) {
		e.preventDefault();
		const f = e.target;
		await DataStore.assignHomework({ studentId: f.studentId.value, courseId: f.courseId.value, groupId: f.groupId.value, title: f.title.value, description: f.description.value });
		closeAssignHw();
		alert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
	}
	async function onRemoveUser(id) { if (confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) { await DataStore.removeUser(id); Router.render(); } }
	async function onAddSchedule(e) { e.preventDefault(); const f=e.target; await DataStore.addSchedule({ weekday:f.weekday.value, time:f.time.value, courseId:f.courseId.value, groupId:f.groupId.value, room:f.room.value }); Router.render(); }
	async function onRemoveSchedule(id) { if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ?')) { await DataStore.removeSchedule(id); Router.render(); } }
	async function onSetRole(id, role) { await DataStore.setUserRole(id, role); }
	async function onAddCourse(e) { e.preventDefault(); const f=e.target; try{ await DataStore.addCourse({ id:f.id.value.trim(), title:f.title.value.trim(), level:f.level.value.trim(), duration:f.duration.value.trim(), tags:f.tags.value.trim(), description:f.description.value.trim() }); alert('–ö—É—Ä—Å –¥–æ–±–∞–≤–ª–µ–Ω'); Router.render(); } catch(err){ alert(err.message); } }
	async function onRemoveCourse(id) { if (confirm('–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å?')) { await DataStore.removeCourse(id); Router.render(); } }
async function onSetGrades(e) { e.preventDefault(); const f=e.target; const scheduleId=f.scheduleId.value; const users=DataStore.getUsers().filter(u=>u.role==='–°—Ç—É–¥–µ–Ω—Ç'); for(const s of users){ const val=f[`grade_${s.id}`]?.value; if (val) await DataStore.setSessionGrade({ scheduleId, studentId:s.id, grade:Number(val) }); } alert('–û—Ü–µ–Ω–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'); }
async function onAssignHwForSession(e) { e.preventDefault(); const f=e.target; const scheduleId=f.scheduleId.value; const courseId=(f.scheduleId.selectedOptions[0].dataset.course); const groupId=(f.scheduleId.selectedOptions[0].dataset.group); await DataStore.assignHomeworkForSession({ scheduleId, courseId, groupId, title:f.title.value.trim(), description:f.description.value.trim() }); alert('–î–ó –≤—ã–¥–∞–Ω–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º –≥—Ä—É–ø–ø—ã'); f.reset(); }

	function escapeHtml(s) { return String(s||'').replace(/[&<>"]+/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }

	Router.on('/', pageHome);
	Router.on('/courses', pageCourses);
	Router.on('/schedule', pageSchedule);
	Router.on('/account', pageAccount);
	Router.on('/login', pageLogin);
	Router.on('/register', pageRegister);
	Router.on('/homework', pageStudentHomework);
	Router.on('/students', pageTeacherStudents);
	Router.on('/admin', pageAdminManage);
	Router.on('/feedback', pageFeedback);
	Router.otherwise(pageNotFound);

	async function onAddGroup(e) {
		e.preventDefault();
		const f = e.target;
		try {
			await DataStore.addGroup({
				name: f.name.value.trim(),
				courseId: f.courseId.value,
				teacherId: f.teacherId.value,
				description: f.description.value.trim()
			});
			alert('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
			Router.render();
		} catch(err) {
			alert(err.message);
		}
	}
	async function onRemoveGroup(groupId) {
		if (confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) {
			await DataStore.removeGroup(groupId);
			Router.render();
		}
	}
	async function onAssignStudentToGroup(studentId, groupId) {
		if (groupId) {
			await DataStore.assignUserToGroup(studentId, groupId);
			Router.render();
		}
	}

	async function forceReloadData() {
		try {
			await DataStore.forceReloadFromJson();
			alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ BD.json!');
			Router.render();
		} catch (error) {
			alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
		}
	}

	async function downloadBD() {
		try {
			const data = await DataStore.load();
			const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'BD.json';
			a.style.display = 'none';
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
			alert('‚úÖ –§–∞–π–ª BD.json —Å–∫–∞—á–∞–Ω! –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –Ω–æ–≤—ã–º.');
		} catch (error) {
			alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏: ' + error.message);
		}
	}

	function onAdminFilterUsers() {
		const search = document.getElementById('adminUsersSearch')?.value.trim().toLowerCase() || '';
		const role = document.getElementById('adminUsersRole')?.value || '';
		document.querySelectorAll('#adminUsersTable tbody tr').forEach(row => {
			const rowRole = row.getAttribute('data-role') || '';
			const matchRole = !role || rowRole === role;
			const text = `${row.getAttribute('data-name')||''} ${row.getAttribute('data-email')||''}`;
			const matchText = !search || text.includes(search);
			row.style.display = matchRole && matchText ? '' : 'none';
		});
	}

	function onAdminFilterSchedule() {
		const search = document.getElementById('adminScheduleSearch')?.value.trim().toLowerCase() || '';
		const course = (document.getElementById('adminScheduleCourse')?.value || '').toLowerCase();
		document.querySelectorAll('#adminScheduleTable tbody tr').forEach(row => {
			const rowCourse = row.getAttribute('data-course') || '';
			const day = row.getAttribute('data-day') || '';
			const time = row.getAttribute('data-time') || '';
			const matchCourse = !course || rowCourse === course;
			const matchSearch = !search || rowCourse.includes(search) || day.includes(search) || time.includes(search);
			row.style.display = matchCourse && matchSearch ? '' : 'none';
		});
	}

	function onAdminFilterCourses() {
		const search = document.getElementById('adminCoursesSearch')?.value.trim().toLowerCase() || '';
		const level = (document.getElementById('adminCoursesLevel')?.value || '').toLowerCase();
		document.querySelectorAll('#adminCoursesTable tbody tr').forEach(row => {
			const rowLevel = row.getAttribute('data-level') || '';
			const rowTitle = row.getAttribute('data-title') || '';
			const rowTags = row.getAttribute('data-tags') || '';
			const matchLevel = !level || rowLevel === level;
			const text = `${rowTitle} ${rowTags}`;
			const matchText = !search || text.includes(search);
			row.style.display = matchLevel && matchText ? '' : 'none';
		});
	}

	window.Pages = { onCourseSearch, onCourseFilterLevel, onProfileSave, onProfileReset, onFeedbackSubmit, onLogin, onRegister, onLogout, openAssignHw, closeAssignHw, onAssignHw, onRemoveUser, onAddSchedule, onRemoveSchedule, onSetRole, onAddCourse, onRemoveCourse, onSetGrades, onAssignHwForSession, onAddGroup, onRemoveGroup, onAssignStudentToGroup, forceReloadData, downloadBD, onAdminFilterUsers, onAdminFilterSchedule, onAdminFilterCourses };
})();


